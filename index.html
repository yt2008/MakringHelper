<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Lab Marking Script — Tasks 1-8</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--muted:#555;--accent:#0b61d6}
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 18px; background:#f6f8fa; color:#111; }
    .card { background:#fff; border-radius:10px; padding:18px; box-shadow:0 8px 30px rgba(15,30,50,0.06); max-width:1100px; margin:0 auto; }
    h1 { margin:0 0 12px 0; font-size:20px; }
    h2 { margin:18px 0 8px 0; font-size:16px; color:var(--accent); }
    ul { list-style:none; padding-left:0; margin:0; }
    li { margin:6px 0; }
    label { cursor:pointer; display:inline-flex; align-items:center; gap:8px; user-select:none; }
    input[type="checkbox"] { width:18px; height:18px; margin:0; }
    #overallComment { border:1px solid #e6eef8; background:#fbfdff; padding:12px; min-height:120px; white-space:pre-wrap; border-radius:6px; margin-top:8px; }
    .controls { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    button { background:var(--accent); color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    button.ghost { background:#e6eef8; color:var(--accent); border:1px solid #cfe0fb; }
    .stats { display:flex; gap:12px; margin-top:12px; flex-wrap:wrap; }
    .stat { background:#fff; border:1px solid #eef3fb; padding:8px 10px; border-radius:8px; min-width:160px; }
    .muted { color:var(--muted); font-size:13px; }
    .score { font-weight:700; font-size:18px; color:#0a7a0a; }
    footer { margin-top:18px; font-size:13px; color:var(--muted); }
    .note { font-size:13px; color:var(--muted); margin-top:6px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Lab Marking Script — Tasks 1–8</h1>
    <div class="note">Click the text to toggle a checkbox. Checked items are appended to the Overall Comment (grouped under their Task heading). Computed deduction and resulting score are shown below.</div>

    <!-- TASKS -->
    <section id="tasks">

      <h2>Task 1: Homepage</h2>
      <ul>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25: Missing required info in rendered template (system name, student name, student ID)"> -0.25: Missing required info in rendered template (system name, student name, student ID)</label></li>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25: Template not rendered with res.render or route not responding with HTML."> -0.25: Template not rendered with res.render or route not responding with HTML.</label></li>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25: Hyperlinks to Books List, Add Book Form, Rentals List, and Add Rental Form are missing or broken."> -0.25: Hyperlinks to Books List, Add Book Form, Rentals List, and Add Rental Form are missing or broken.</label></li>
        <li><label><input type="checkbox" data-ded="0" data-text="0: Endpoint not implemented."> 0: Endpoint not implemented.</label></li>
      </ul>

      <h2>Task 2: Show Table 1 (Books list)</h2>
      <ul>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25: Book list view not rendered with EJS directives to loop and display all books from MongoDB using the Book model"> -0.25: Book list view not rendered with EJS directives to loop and display all books from MongoDB using the Book model</label></li>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25: HTML table missing or does not include required attributes per schema (bookTitle, bookAuthor, rentalPrice)"> -0.25: HTML table missing or does not include required attributes per schema (bookTitle, bookAuthor, rentalPrice)</label></li>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25: Does not show book count in the page as specified in scenario notes"> -0.25: Does not show book count in the page as specified in scenario notes</label></li>
        <li><label><input type="checkbox" data-ded="0" data-text="0: Endpoint not implemented."> 0: Endpoint not implemented.</label></li>
      </ul>

      <h2>Task 3: Add Table 1 (GET)</h2>
      <ul>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25: Form missing any required field input: bookTitle, bookAuthor, rentalPrice, with proper types (text, text, number) and submit button"> -0.25: Form missing any required field input: bookTitle, bookAuthor, rentalPrice, with proper types (text, text, number) and submit button</label></li>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25: Form action not pointing to POST /studentFirstName/books/add or uses the wrong HTTP method"> -0.25: Form action not pointing to POST /studentFirstName/books/add or uses the wrong HTTP method</label></li>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25: View not rendered as HTML via res.render, or malformed/invalid inputs allowed for numeric field"> -0.25: View not rendered as HTML via res.render, or malformed/invalid inputs allowed for numeric field</label></li>
        <li><label><input type="checkbox" data-ded="0" data-text="0: Endpoint not implemented"> 0: Endpoint not implemented</label></li>
      </ul>

      <h2>Task 4: Add Table 1 (POST)</h2>
      <ul>
        <li><label><input type="checkbox" data-ded="-0.5" data-text="-0.5: New Book document is not created with Mongoose and saved to MongoDB"> -0.5: New Book document is not created with Mongoose and saved to MongoDB</label></li>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25: Form data not correctly extracted from req.body or field names mismatch schema keys (bookTitle, bookAuthor, rentalPrice)"> -0.25: Form data not correctly extracted from req.body or field names mismatch schema keys (bookTitle, bookAuthor, rentalPrice)</label></li>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25: Missing middleware to parse body, resulting in failed processing (only penalise here once)"> -0.25: Missing middleware to parse body, resulting in failed processing (only penalise here once)</label></li>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25: Validation/type issues not handled (non-number for rentalPrice accepted or save attempted without required fields)"> -0.25: Validation/type issues not handled (non-number for rentalPrice accepted or save attempted without required fields)</label></li>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25: Does not redirect to /studentFirstName/books after successful add"> -0.25: Does not redirect to /studentFirstName/books after successful add</label></li>
        <li><label><input type="checkbox" data-ded="0" data-text="0: Endpoint not implemented"> 0: Endpoint not implemented</label></li>
      </ul>

      <h2>Task 5: Show Table 2 (Rentals list)</h2>
      <ul>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25: Rentals list view not rendered with EJS and does not use populate to show the related Book title for each rental"> -0.25: Rentals list view not rendered with EJS and does not use populate to show the related Book title for each rental</label></li>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25: HTML table missing or does not include required attributes (customerName, rentalDays, totalCost, and populated book title)"> -0.25: HTML table missing or does not include required attributes (customerName, rentalDays, totalCost, and populated book title)</label></li>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25: Fails to query rentals from MongoDB or returns a non-HTML response"> -0.25: Fails to query rentals from MongoDB or returns a non-HTML response</label></li>
        <li><label><input type="checkbox" data-ded="0" data-text="0: Endpoint not implemented"> 0: Endpoint not implemented</label></li>
      </ul>

      <h2>Task 6: Add Table 2 (GET)</h2>
      <ul>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25: Form missing required inputs for customerName and rentalDays and a select/dropdown of available Books sourced from DB (bookId)"> -0.25: Form missing required inputs for customerName and rentalDays and a select/dropdown of available Books sourced from DB (bookId)</label></li>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25: Form action not pointing to POST /studentFirstName/rentals/add or wrong HTTP method"> -0.25: Form action not pointing to POST /studentFirstName/rentals/add or wrong HTTP method</label></li>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25: Dropdown not populated from live Book collection or value does not submit a valid ObjectId"> -0.25: Dropdown not populated from live Book collection or value does not submit a valid ObjectId</label></li>
        <li><label><input type="checkbox" data-ded="0" data-text="0: Endpoint not implemented"> 0: Endpoint not implemented</label></li>
      </ul>

      <h2>Task 7: Add Table 2 (POST)</h2>
      <ul>
        <li><label><input type="checkbox" data-ded="-0.5" data-text="-0.5: Rental document not created and saved to MongoDB with a valid bookId reference"> -0.5: Rental document not created and saved to MongoDB with a valid bookId reference</label></li>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25: Form data not correctly extracted from req.body or field names mismatch schema keys (customerName, rentalDays..)"> -0.25: Form data not correctly extracted from req.body or field names mismatch schema keys (customerName, rentalDays..)</label></li>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25: Missing or incorrect use of Mongoose types (e.g., rentalDays not cast to Number, invalid ObjectId) or failure to validate"> -0.25: Missing or incorrect use of Mongoose types (e.g., rentalDays not cast to Number, invalid ObjectId) or failure to validate</label></li>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25: Does not redirect to /studentFirstName/rentals after adding"> -0.25: Does not redirect to /studentFirstName/rentals after adding</label></li>
        <li><label><input type="checkbox" data-ded="0" data-text="0: Endpoint not implemented"> 0: Endpoint not implemented</label></li>
      </ul>

      <h2>Shared rule for Labs 03,04,05,09</h2>
      <ul>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25 (Labs 03/04/05/09): totalCost not calculated server-side as rentalDays × selected Book.rentalPrice before save (must not come from the form)"> -0.25 (Labs 03/04/05/09): totalCost not calculated server-side as rentalDays × selected Book.rentalPrice before save (must not come from the form)</label></li>
      </ul>

      <h2>Task 8: Details (Params)</h2>
      <ul>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25: Not using route param"> -0.25: Not using route param</label></li>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25: Book not fetched by param id using Mongoose"> -0.25: Book not fetched by param id using Mongoose</label></li>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25: Does not also fetch and display all rentals for that book (using bookId) or fails to show them in an HTML table"> -0.25: Does not also fetch and display all rentals for that book (using bookId) or fails to show them in an HTML table</label></li>
        <li><label><input type="checkbox" data-ded="-0.25" data-text="-0.25: EJS template not rendered or missing key fields for the Book and its Rentals; failure to use EJS directives to iterate data"> -0.25: EJS template not rendered or missing key fields for the Book and its Rentals; failure to use EJS directives to iterate data</label></li>
        <li><label><input type="checkbox" data-ded="0" data-text="0: Endpoint not implemented"> 0: Endpoint not implemented</label></li>
      </ul>

      <h2>General Deduction</h2>
      <ul>
        <li><label><input type="checkbox" data-ded="0" data-text="General deductions (manual judgement) — use note field"> General deductions (manual judgement) — use note field</label></li>
      </ul>

    </section>

    <!-- output / controls -->
    <div class="stats">
      <div class="stat"><div class="muted">Computed deduction</div><div id="computedDed">0.00</div></div>
      <div class="stat"><div class="muted">Score (out of 5)</div><div id="score" class="score">5.00</div></div>
    </div>

    <h2 style="margin-top:14px">Overall Comment</h2>
    <div id="overallComment" aria-live="polite"></div>

    <div class="controls">
      <button id="copyBtn">Copy Comment</button>
      <button id="clearBtn" class="ghost">Clear Selection</button>
    </div>

    <footer>
      Tip: click any line's text to toggle the checkbox. Decimal deductions are summed; zero-value items are shown in comments but do not affect the score.
    </footer>
  </div>

  <script>
    // helper: parse float safely, default 0
    function parseDed(v) {
      const n = parseFloat(v);
      return isNaN(n) ? 0 : n;
    }

    function update() {
      const computedEl = document.getElementById('computedDed');
      const scoreEl = document.getElementById('score');
      const commentEl = document.getElementById('overallComment');

      commentEl.innerHTML = ''; // reset

      // compute sum
      let sum = 0;
      // iterate h2 sections
      const headings = Array.from(document.querySelectorAll('#tasks h2'));
      headings.forEach(h2 => {
        const next = h2.nextElementSibling;
        if (!next || next.tagName !== 'UL') return;
        const checked = Array.from(next.querySelectorAll('input[type="checkbox"]:checked'));
        if (checked.length === 0) return;
        // append heading
        const titleNode = document.createElement('div');
        titleNode.innerHTML = '<strong>' + h2.textContent + '</strong>';
        commentEl.appendChild(titleNode);

        // append each checked item text
        checked.forEach(cb => {
          const text = cb.dataset.text || cb.parentElement.textContent.trim();
          const lineNode = document.createElement('div');
          // ensure leading dash if not present
          const display = (text.trim().startsWith('-') ? text.trim() : ('- ' + text.trim()));
          lineNode.textContent = display;
          commentEl.appendChild(lineNode);

          // add deduction (data-ded attribute holds numeric deduction, might be negative or 0)
          const ded = parseDed(cb.dataset.ded);
          sum += ded;
        });

        // blank line after section
        commentEl.appendChild(document.createElement('br'));
      });

      // computed deduction is sum (note: data-ded uses negative values for deductions, sum will be negative)
      // We want "deduction marks" as positive number = -sum (if values negative). But some entries may be positive zero.
      // Normalize: treat data-ded as negative or zero. We'll compute totalDeduction = -sum if sum <= 0 else sum.
      let totalDeduction = 0;
      if (sum === 0) {
        totalDeduction = 0;
      } else if (sum < 0) {
        totalDeduction = -sum;
      } else {
        // if instructor used positive numbers, accept them as deduction
        totalDeduction = sum;
      }

      // cap deduction at 5
      if (totalDeduction > 5) totalDeduction = 5;

      const finalScore = Math.max(0, 5 - totalDeduction);

      computedEl.textContent = totalDeduction.toFixed(2);
      scoreEl.textContent = finalScore.toFixed(2);
    }

    // copy comment to clipboard
    document.getElementById('copyBtn').addEventListener('click', async () => {
      const txt = document.getElementById('overallComment').innerText.trim();
      if (!txt) {
        alert('No comment to copy.');
        return;
      }
      try {
        await navigator.clipboard.writeText(txt);
        alert('Comment copied to clipboard.');
      } catch (e) {
        // fallback
        const ta = document.createElement('textarea');
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
        alert('Comment copied to clipboard (fallback).');
      }
    });

    // clear selections
    document.getElementById('clearBtn').addEventListener('click', () => {
      document.querySelectorAll('#tasks input[type="checkbox"]').forEach(cb => cb.checked = false);
      update();
    });

    // attach listeners: all labels wrap the checkbox so clicks toggle automatically.
    document.querySelectorAll('#tasks input[type="checkbox"]').forEach(cb => cb.addEventListener('change', update));

    // init
    update();
  </script>
</body>
</html>
